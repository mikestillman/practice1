# @configure_input@

# DOTS is the path to M2/Macaulay2 from this directory
DOTS ?= ../../..

include $(DOTS)/../include/config.Makefile
VPATH = @srcdir@

CPPFLAGS := -I$(DOTS)/../include $(CPPFLAGS) 
CPPFLAGS += -I$(DOTS)/../libraries/final/include

LDFLAGS += -L$(DOTS)/../libraries/final/lib

TESTRESULTS := $(notdir $(patsubst %.m2, %.okay, $(wildcard @srcdir@/*.m2)))

all:
all:check
check: $(TESTRESULTS) check-gc

$(TESTRESULTS) : @pre_exec_prefix@/bin/M2@EXE@

ARGS := --silent -q --stop --no-loaddata --no-setup -e 'srcdir = "@srcdir@/"'

LIMIT :=
ifeq (@ULIMIT_T@,yes)
LIMIT += ulimit -t 20 ;
endif
ifeq (@ULIMIT_M@,yes)
LIMIT += ulimit -m 500000 ;
endif
ifeq (@ULIMIT_V@,yes)
LIMIT += ulimit -v 500000 ;
endif
ifeq (@ULIMIT_S@,yes)
LIMIT += ulimit -s 8192 ;
endif

%.okay : %.m2
	@ echo testing $<
	@ $(LIMIT) env @pre_exec_prefix@/bin/M2@EXE@ $(ARGS) $< -e 'exit 0'
	@ touch $@

clean::	; rm -f *.okay
LOADLIBES += @GC_LIBS@
testgc:
check-gc: testgc.okay
testgc.okay : testgc ; ./testgc && touch $@
clean::; rm -f testgc
clean::; rm -rf *.dSYM
Makefile : Makefile.in ; cd $(DOTS)/.. && ./config.status Macaulay2/packages/Macaulay2Doc/basictests/Makefile
distclean :clean; rm -f Makefile
check: check-return-code
check-return-code :; if echo 'error "foo"' | @pre_exec_prefix@/bin/M2@EXE@ $(ARGS) 2>/dev/null 1>&2 ; then false ; else true ; fi

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/Macaulay2/packages/Macaulay2Doc/basictests "
# End:
